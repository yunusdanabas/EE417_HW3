# Stereo 3D Reconstruction Pipeline

This repository implements a full stereo vision pipeline for 3D reconstruction using a pair of images. The pipeline includes camera calibration, image undistortion, feature matching, epipolar geometry estimation, triangulation, and error analysis. The code is modular, with each step handled by a dedicated script.

## Directory Structure

- `src/` — Main source code for the pipeline.
- `calib/` — Calibration images and saved calibration data.
- `images/` — Original stereo image pairs.
- `results/` — Output files generated by the pipeline.
- `report/` — (Empty) Placeholder for reports or documentation.

---

## Pipeline Overview

The main entry point is `src/main.py`, which runs the entire pipeline in sequence:

1. **Camera Calibration** (`calibrate.py`)
2. **Image Undistortion** (`undistort.py`)
3. **Feature Matching** (`match.py`)
4. **Epipolar Geometry & Pose Estimation** (`geom.py`)
5. **Triangulation** (`triangulate.py`)
6. **Detector Comparison** (`compare_detectors.py`)
7. **Epipolar Error Analysis** (`epipolar_error.py`)
8. **3D Reprojection Error Analysis** (`reprojection_error.py`)

---

## Code Explanations

### 1. `calibrate.py`
- **Purpose:** Calibrates the camera using checkerboard images in `calib/`.
- **Key Steps:**
  - Detects checkerboard corners in all calibration images.
  - Computes camera intrinsic matrix (`K.npy`) and distortion coefficients (`dist.npy`).
  - Saves calibration results and a preview image (`results/calib_preview.png`).

### 2. `undistort.py`
- **Purpose:** Undistorts the original stereo images using calibration data.
- **Key Steps:**
  - Loads `K.npy` and `dist.npy`.
  - Undistorts `images/scene_left.jpg` and `images/scene_right.jpg`.
  - Saves undistorted images to `results/`.

### 3. `match.py`
- **Purpose:** Extracts and matches keypoints between the undistorted stereo images.
- **Key Steps:**
  - Supports SIFT and ORB detectors.
  - Performs feature detection and matching.
  - Saves a visualization of matches (`results/matches_sift.png` or `results/matches_orb.png`).
  - Prints a summary table of keypoints and matches.

### 4. `geom.py`
- **Purpose:** Estimates the epipolar geometry and relative pose between the two cameras.
- **Key Steps:**
  - Finds the fundamental matrix using matched keypoints.
  - Computes the essential matrix and recovers the camera pose.
  - Draws and saves epipolar lines (`results/epi_lines.png`).

### 5. `triangulate.py`
- **Purpose:** Triangulates 3D points from matched keypoints.
- **Key Steps:**
  - Uses the recovered camera pose and calibration data.
  - Triangulates points and filters those in front of the camera.
  - Saves the 3D point cloud (`results/pointcloud.xyz`) and a 3D scatter plot (`results/pointcloud.png`).

### 6. `compare_detectors.py`
- **Purpose:** Compares SIFT and ORB detectors on the stereo pair.
- **Key Steps:**
  - Runs the full matching, pose, and triangulation pipeline for both detectors.
  - Prints a table comparing the number of keypoints, matches, inliers, and triangulated 3D points.

### 7. `epipolar_error.py`
- **Purpose:** Analyzes the epipolar constraint error for each detector.
- **Key Steps:**
  - Computes the mean, median, and max epipolar error for SIFT and ORB.
  - Prints a summary table.

### 8. `reprojection_error.py`
- **Purpose:** Analyzes the 3D reprojection error for each detector.
- **Key Steps:**
  - Triangulates 3D points and projects them back to both images.
  - Computes the mean reprojection error for left and right images.
  - Prints a summary table.

### 9. `utils.py`
- **Purpose:** Utility functions for the pipeline.
- **Key Function:**
  - `print_table`: Prints formatted tables for summaries and results.

---

## Data Files

- **Calibration Images:** `calib/board*.jpg`
- **Stereo Images:** `images/scene_left.jpg`, `images/scene_right.jpg`
- **Calibration Results:** `calib/K.npy`, `calib/dist.npy`
- **Pipeline Outputs:** Saved in `results/` (undistorted images, matches, epipolar lines, point cloud, etc.)

---

## How to Run

1. Place your calibration images in `calib/` and stereo images in `images/`.
2. Run the pipeline:
   ```bash
   python src/main.py --detector SIFT
   ```
   - Use `--detector ORB` to switch to ORB features.

---

## Requirements

- Python 3.x
- OpenCV
- NumPy
- Matplotlib
- Plotly

Install dependencies with:
```bash
pip install opencv-python numpy matplotlib plotly
```

---

## Output Files

The pipeline generates several output files in the `results/` directory:

1. **Calibration Results:**
   - `calib_preview.png`: Visualization of checkerboard detection
   - `K.npy`: Camera intrinsic matrix
   - `dist.npy`: Distortion coefficients

2. **Image Processing:**
   - `undistorted_scene_left.png`: Undistorted left image
   - `undistorted_scene_right.png`: Undistorted right image

3. **Feature Matching:**
   - `feature_matches.png`: Visualization of matched keypoints
   - `epipolar_lines.png`: Visualization of epipolar lines

4. **3D Reconstruction:**
   - `pointcloud.xyz`: Raw 3D point cloud data
   - `pointcloud.ply`: Colored point cloud in PLY format (can be opened in MeshLab, CloudCompare, etc.)
   - `pointcloud.png`: Static 3D visualization
   - `interactive_pointcloud.html`: Interactive 3D visualization (open in web browser)
   - `reprojection_errors.png`: Distribution of reprojection errors

---

## Visualization Options

The pipeline provides multiple ways to visualize the 3D reconstruction:

1. **Static Visualization:**
   - Basic 3D scatter plot saved as PNG
   - Shows point cloud and camera poses
   - Good for quick inspection

2. **Interactive Visualization:**
   - HTML-based interactive 3D visualization
   - Features:
     - Rotate, pan, and zoom
     - Toggle visibility of point cloud and camera poses
     - Color-coded camera coordinate frames
     - Export to PNG
   - Open `results/interactive_pointcloud.html` in a web browser

3. **3D Point Cloud Viewers:**
   - PLY format point cloud can be opened in:
     - MeshLab (free, open-source)
     - CloudCompare (free, open-source)
     - Blender (free, open-source)
     - Other 3D point cloud viewers
   - Features:
     - Full 3D navigation
     - Point cloud filtering and processing
     - Measurement tools
     - Export to various formats

4. **Error Analysis:**
   - Reprojection error distribution plots
   - Epipolar line visualization
   - Feature match visualization

---

## Notes

- All results and intermediate files are saved in the `results/` directory.
- The code is modular; each script can be run independently for debugging or analysis.
- For best results:
  - Use high-quality calibration images with good checkerboard visibility
  - Ensure stereo images have sufficient overlap and texture
  - Adjust parameters in `triangulate.py` if needed:
    - `RATIO`: Feature matching ratio test threshold
    - `RANSAC_TH`: RANSAC threshold for fundamental matrix
    - `REPROJ_TH`: Maximum allowed reprojection error
    - `MAX_DEPTH` and `MIN_DEPTH`: Depth range limits


